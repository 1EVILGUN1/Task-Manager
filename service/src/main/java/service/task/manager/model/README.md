# README.md для папки `model`

## Описание

Папка `model` содержит сущности (модели) и перечисления, используемые для представления данных в приложении `service.task.manager`. Модели описывают структуру данных для задач, эпиков, подзадач и записей истории, которые хранятся в базе данных. Папка также включает подпапку `enums`, содержащую перечисления для статусов и типов задач. Сущности аннотированы с использованием JPA (Jakarta Persistence API) для работы с реляционной базой данных через Hibernate.

## Структура папки

### 1. Модели

- **`Epic.java`**  
  **Описание**: Сущность, представляющая эпик — крупную задачу, которая может содержать подзадачи.  
  **Поля**:
    - `id` (`Long`, автоинкремент) — Уникальный идентификатор эпика.
    - `subtasks` (`List<Subtask>`) — Список связанных подзадач (связь `@OneToMany`).
    - `name` (`String`, обязательное) — Название эпика.
    - `description` (`String`) — Описание эпика.
    - `status` (`Status`) — Статус эпика (`NEW`, `IN_PROGRESS`, `DONE`).
    - `startTime` (`LocalDateTime`) — Время начала эпика.
    - `duration` (`Duration`) — Длительность эпика.
    - `endTime` (`LocalDateTime`) — Время окончания, рассчитывается автоматически.
    - `type` (`TaskType`, только для чтения) — Тип задачи (всегда `EPIC`).  
      **Особенности**:
    - Аннотация `@PrePersist` и `@PreUpdate` для автоматического расчета `endTime` на основе `startTime` и `duration`.
    - Связь с подзадачами настроена с каскадным удалением (`cascade = CascadeType.ALL`, `orphanRemoval = true`).

- **`HistoryEntry.java`**  
  **Описание**: Класс для представления записи в истории доступа к задачам, эпикам или подзадачам.  
  **Поля**:
    - `type` (`TaskType`) — Тип сущности (`TASK`, `SUBTASK`, `EPIC`).
    - `id` (`Long`) — Идентификатор сущности.  
      **Особенности**:
    - Не является JPA-сущностью, используется для передачи данных о вызове метода `findById` (хранится в Redis).

- **`Subtask.java`**  
  **Описание**: Сущность, представляющая подзадачу, связанную с эпикой.  
  **Поля**:
    - `id` (`Long`, автоинкремент) — Уникальный идентификатор подзадачи.
    - `epic` (`Epic`) — Связанный эпик (связь `@ManyToOne`).
    - `name` (`String`, обязательное) — Название подзадачи.
    - `description` (`String`) — Описание подзадачи.
    - `status` (`Status`) — Статус подзадачи.
    - `startTime` (`LocalDateTime`) — Время начала.
    - `endTime` (`LocalDateTime`) — Время окончания, рассчитывается автоматически.
    - `duration` (`Duration`) — Длительность подзадачи.
    - `type` (`TaskType`, только для чтения) — Тип задачи (всегда `SUBTASK`).  
      **Особенности**:
    - Автоматический расчет `endTime` через `@PrePersist` и `@PreUpdate`.
    - Связь с эпикой через внешний ключ (`epic_id`).

- **`Task.java`**  
  **Описание**: Сущность, представляющая независимую задачу.  
  **Поля**:
    - `id` (`Long`, автоинкремент) — Уникальный идентификатор задачи.
    - `name` (`String`, обязательное) — Название задачи.
    - `description` (`String`) — Описание задачи.
    - `status` (`Status`) — Статус задачи.
    - `startTime` (`LocalDateTime`) — Время начала.
    - `endTime` (`LocalDateTime`) — Время окончания, рассчитывается автоматически.
    - `duration` (`Duration`) — Длительность задачи.
    - `type` (`TaskType`, только для чтения) — Тип задачи (всегда `TASK`).  
      **Особенности**:
    - Автоматический расчет `endTime` через `@PrePersist` и `@PreUpdate`.

### 2. Папка `enums`

- **`Status.java`**  
  **Описание**: Перечисление, определяющее возможные статусы задач, эпиков и подзадач.  
  **Значения**:
    - `NEW` — Новая задача/эпик/подзадача.
    - `IN_PROGRESS` — В процессе выполнения.
    - `DONE` — Завершена.  
      **Использование**: Хранится в базе данных как строка (`@Enumerated(EnumType.STRING)`).

- **`TaskType.java`**  
  **Описание**: Перечисление, определяющее тип сущности.  
  **Значения**:
    - `TASK` — Независимая задача.
    - `SUBTASK` — Подзадача, связанная с эпикой.
    - `EPIC` — Эпик, содержащий подзадачи.  
      **Использование**: Используется для идентификации типа сущности в базе данных и в истории доступа.

## Основные особенности

- **JPA-аннотации**:
    - `@Entity` и `@Table` для маппинга сущностей на таблицы базы данных (`task`, `epic`, `subtask`).
    - `@Id` и `@GeneratedValue` для автоинкрементных идентификаторов.
    - `@OneToMany` и `@ManyToOne` для связей между эпиками и подзадачами.
    - `@Enumerated(EnumType.STRING)` для хранения перечислений как строк.
- **Автоматический расчет `endTime`**: Все сущности (`Task`, `Epic`, `Subtask`) используют метод `calculateEndTime`, вызываемый перед сохранением или обновлением, для вычисления `endTime` на основе `startTime` и `duration`.
- **Lombok**: Аннотации `@Getter`, `@Setter`, `@ToString`, `@RequiredArgsConstructor` и др. используются для упрощения кода.
- **Равенство и хэш-код**: Реализованы методы `equals` и `hashCode`, основанные на поле `id`, для корректной работы с коллекциями и Hibernate.
- **Исключение циклических ссылок**: В `@ToString` для `Epic` исключено поле `subtasks`, чтобы избежать рекурсии при выводе.

## Использование

Модели используются в сервисах и репозиториях для работы с базой данных. Они представляют данные, хранимые в таблицах, и используются мапперами (`mapper`) для преобразования в DTO и обратно.

**Пример использования в сервисе**:
```java
Epic epic = new Epic();
epic.setName("Новый эпик");
epic.setStartTime(LocalDateTime.now());
epic.setDuration(Duration.ofHours(24));
epicRepository.save(epic); // endTime рассчитается автоматически
```

**Пример записи в историю**:
```java
HistoryEntry entry = new HistoryEntry(TaskType.EPIC, epic.getId());
historyService.save(entry);
```

## Зависимости

- **Hibernate/JPA**: Для работы с базой данных.
- **Lombok**: Для генерации геттеров, сеттеров и других методов.
- **DTO**: Пакет `service.task.manager.dto` для преобразования моделей в DTO через мапперы.
- **MapStruct**: Пакет `service.task.manager.mapper` для маппинга.

## Документация API

Модели не документируются напрямую в Swagger, но их структура отражена в DTO, которые описаны в Swagger UI:
- **Swagger UI**: `http://localhost:8080/swagger-ui.html`
- **OpenAPI JSON**: `http://localhost:8080/v3/api-docs`

## Примечания

- **Автоматический расчет `endTime`**: Поле `endTime` не должно устанавливаться вручную, так как оно вычисляется автоматически.
- **Связи**: Подзадачи автоматически удаляются при удалении эпика благодаря настройке `orphanRemoval = true`.
- **Перечисления**: `Status` и `TaskType` хранятся как строки в базе данных для удобства чтения и расширения.
- **История**: `HistoryEntry` используется только для кэширования в Redis, а не для хранения в реляционной базе данных.

## Дополнительно

Для информации о мапперах, DTO, контроллерах или сервисах см. соответствующие папки (`mapper`, `dto`, `controller`, `service`). По вопросам настройки или расширения моделей обратитесь к документации проекта или разработчикам.