# README.md для папки `service`

## Описание

Папка `service` содержит интерфейсы сервисов и их реализации для приложения `service.task.manager`. Сервисы реализуют бизнес-логику приложения, включая создание, обновление, получение и удаление задач, эпиков, подзадач, а также управление историей доступа. Интерфейсы определяют контракт для каждого сервиса, а их реализации находятся в подпапке `impl`. Все сервисы используют Spring-компоненты, транзакции, мапперы, репозитории и обработку исключений для обеспечения надежной работы.

## Структура папки

### 1. Интерфейсы сервисов

- **`EpicService.java`**  
  **Описание**: Интерфейс для управления эпиками.  
  **Методы**:
    - `create(EpicRequestCreatedDto)` — Создание нового эпика.
    - `update(EpicRequestUpdatedDto) → EpicResponseDto` — Обновление существующего эпика.
    - `findById(Long) → EpicResponseDto` — Получение эпика по ID.
    - `findAll() → List<EpicResponseDto>` — Получение всех эпиков.
    - `delete(Long)` — Удаление эпика по ID.
    - `prioritized() → List<EpicResponseDto>` — Получение эпиков, отсортированных по приоритету (`IN_PROGRESS`, `NEW`, `DONE`) и времени завершения.

- **`HistoryService.java`**  
  **Описание**: Интерфейс для управления историей доступа к задачам, эпикам и подзадачам.  
  **Методы**:
    - `addToHistory(TaskType, Long)` — Добавление записи в историю (тип сущности и ID).
    - `getHistory() → List<HistoryEntry>` — Получение последних 10 записей истории.

- **`SubtaskService.java`**  
  **Описание**: Интерфейс для управления подзадачами.  
  **Методы**:
    - `create(SubtaskRequestCreatedDto)` — Создание новой подзадачи.
    - `update(SubtaskRequestUpdatedDto) → SubtaskResponseDto` — Обновление существующей подзадачи.
    - `findById(Long) → SubtaskResponseDto` — Получение подзадачи по ID.
    - `findAll() → List<SubtaskResponseDto>` — Получение всех подзадач.
    - `delete(Long)` — Удаление подзадачи по ID.
    - `prioritized() → List<SubtaskResponseDto>` — Получение подзадач, отсортированных по приоритету и времени завершения.

- **`TaskService.java`**  
  **Описание**: Интерфейс для управления задачами.  
  **Методы**:
    - `create(TaskRequestCreatedDto)` — Создание новой задачи.
    - `update(TaskRequestUpdatedDto) → TaskResponseDto` — Обновление существующей задачи.
    - `findById(Long) → TaskResponseDto` — Получение задачи по ID.
    - `findAll() → List<TaskResponseDto>` — Получение всех задач.
    - `delete(Long)` — Удаление задачи по ID.
    - `prioritized() → List<TaskResponseDto>` — Получение задач, отсортированных по приоритету и времени завершения.

### 2. Папка `impl` (реализации сервисов)

- **`EpicServiceImpl.java`**  
  **Описание**: Реализация `EpicService` для управления эпиками.  
  **Особенности**:
    - Проверяет уникальность имени эпика с помощью `EpicRepository.existsByName`.
    - Устанавливает статус `NEW` для новых эпиков и вызывает расчет `endTime`.
    - Использует `EpicMapper` для преобразования между DTO и сущностями.
    - Добавляет запись в историю при вызове `findById` через `HistoryService`.
    - Реализует сортировку в методе `prioritized` по статусу (`IN_PROGRESS` → `NEW` → `DONE`) и `endTime`.
    - Управляет транзакциями с помощью `@Transactional` (чтение — `readOnly = true`).

- **`HistoryServiceImpl.java`**  
  **Описание**: Реализация `HistoryService` для хранения и получения истории доступа в Redis.  
  **Особенности**:
    - Хранит до 10 записей в Redis (ключ `history`), удаляя старую запись при превышении лимита.
    - Использует `RedisTemplate` и `ListOperations` для работы с Redis.
    - Логирует ошибки и возвращает пустой список в случае сбоя.
    - Не использует транзакции, так как работает с кэшем, а не с базой данных.

- **`SubtaskServiceImpl.java`**  
  **Описание**: Реализация `SubtaskService` для управления подзадачами.  
  **Особенности**:
    - Проверяет существование эпика через `EpicService.findById` перед созданием подзадачи.
    - Проверяет уникальность имени подзадачи с помощью `SubtaskRepository.existsByName`.
    - Устанавливает статус `NEW` и вызывает расчет `endTime` для новых подзадач.
    - Использует `SubtaskMapper` и `EpicMapper` для преобразования данных.
    - Добавляет запись в историю при вызове `findById`.
    - Реализует сортировку в методе `prioritized` аналогично эпикам.
    - Использует `@Transactional` для управления транзакциями.

- **`TaskServiceImpl.java`**  
  **Описание**: Реализация `TaskService` для управления задачами.  
  **Особенности**:
    - Проверяет уникальность имени задачи с помощью `TaskRepository.existsByName`.
    - Устанавливает статус `NEW` и вызывает расчет `endTime` для новых задач.
    - Использует `TaskMapper` для преобразования между DTO и сущностями.
    - Добавляет запись в историю при вызове `findById`.
    - Реализует сортировку в методе `prioritized` аналогично эпикам и подзадачам.
    - Использует `@Transactional` для управления транзакциями.

## Основные особенности

- **Интерфейсы и реализации**: Разделение на интерфейсы и их реализации (`impl`) упрощает тестирование и замену реализаций.
- **Транзакции**: Используется аннотация `@Transactional` для обеспечения целостности данных; операции чтения помечены как `readOnly = true` для оптимизации.
- **Логирование**: Все сервисы используют SLF4J (`@Slf4j`) для логирования операций и ошибок.
- **Обработка ошибок**:
    - `NotFoundException` для отсутствующих ресурсов.
    - `ConflictException` для дублирования имен.
- **Сортировка по приоритету**: Метод `prioritized` сортирует сущности по статусу (`IN_PROGRESS` → `NEW` → `DONE`) и времени завершения (`endTime`).
- **Redis для истории**: `HistoryServiceImpl` использует Redis для хранения истории доступа, обеспечивая быстрый доступ и ограничение размера (10 записей).
- **Маппинг**: Все сервисы используют мапперы (`EpicMapper`, `SubtaskMapper`, `TaskMapper`) для преобразования между DTO и сущностями.

## Использование

Сервисы используются в контроллерах (`controller`) для обработки запросов и реализации бизнес-логики. Они взаимодействуют с репозиториями для доступа к базе данных и мапперами для преобразования данных.

**Пример использования в контроллере**:
```java
@PostMapping
public ResponseEntity<Void> create(@RequestBody @Valid EpicRequestCreatedDto dto) {
    epicService.create(dto);
    return ResponseEntity.status(HttpStatus.CREATED).build();
}
```

**Пример получения истории**:
```java
@GetMapping
public List<HistoryEntry> getHistory() {
    return historyService.getHistory();
}
```

## Зависимости

- **Spring**: Для управления сервисами как бинами (`@Service`) и транзакциями (`@Transactional`).
- **Spring Data JPA**: Для взаимодействия с репозиториями (`EpicRepository`, `SubtaskRepository`, `TaskRepository`).
- **MapStruct**: Для маппинга между DTO и сущностями (`EpicMapper`, `SubtaskMapper`, `TaskMapper`).
- **Redis**: Для хранения истории в `HistoryServiceImpl` через `RedisTemplate`.
- **Lombok**: Для упрощения кода (`@RequiredArgsConstructor`, `@Slf4j`).
- **Исключения**: Пакет `service.task.manager.exception` для обработки ошибок (`NotFoundException`, `ConflictException`).
- **Модели**: Пакет `service.task.manager.model` для работы с сущностями (`Task`, `Epic`, `Subtask`, `HistoryEntry`).

## Документация API

Сервисы косвенно документируются через контроллеры, которые используют их методы. Полная документация доступна в Swagger UI:
- **Swagger UI**: `http://localhost:8080/swagger-ui.html`
- **OpenAPI JSON**: `http://localhost:8080/v3/api-docs`

## Примечания

- **Транзакционная целостность**: Все операции, изменяющие данные, выполняются в транзакциях для обеспечения согласованности.
- **Логирование**: Подробное логирование операций и ошибок помогает в отладке и мониторинге.
- **Ограничение истории**: `HistoryServiceImpl` хранит только последние 10 записей, что оптимизирует использование памяти в Redis.
- **Сортировка**: Логика сортировки в методе `prioritized` унифицирована для всех сущностей, но может быть расширена для дополнительных критериев.
- **Расширяемость**: Новые сервисы можно добавить, создав интерфейс и реализацию, следуя существующей структуре.

## Дополнительно

Для информации о моделях, репозиториях, мапперах или контроллерах см. соответствующие папки (`model`, `repository`, `mapper`, `controller`). По вопросам настройки или расширения сервисов обратитесь к документации проекта или разработчикам.